<script type="module">
  import ESPLoader from 'https://cdn.jsdelivr.net/npm/esptool-js@0.4.1/dist/web/index.js';
  import WebSerialTransport from 'https://cdn.jsdelivr.net/npm/esptool-js@0.4.1/dist/web/transport/webserial.js';

  let loader;

  function log(msg, success = true) {
    const logEl = document.getElementById('log');
    const p = document.createElement('p');
    p.textContent = msg;
    p.className = success ? 'text-green-400' : 'text-red-400';
    logEl.appendChild(p);
    logEl.scrollTop = logEl.scrollHeight;
  }

  document.getElementById('connect-btn').addEventListener('click', async () => {
    try {
      const port = await navigator.serial.requestPort();
      const transport = new WebSerialTransport(port);
      loader = new ESPLoader(transport, false);

      log('Connecting...');
      await loader.initialize();
      const chip = await loader.chipName();
      log(`Connected to chip: ${chip}`);

      document.getElementById('flash-btn').disabled = false;
    } catch (err) {
      log('Error connecting: ' + err.message, false);
    }
  });

  document.getElementById('flash-btn').addEventListener('click', async () => {
    try {
      const response = await fetch('firmware_v1.2.3.bin');
      if (!response.ok) throw new Error('Failed to fetch firmware');

      const fwArrayBuffer = await response.arrayBuffer();
      const fwData = new Uint8Array(fwArrayBuffer);
      log('Firmware loaded');

      await loader.flash([{ data: fwData, address: 0x1000 }]);
      log('Flashing complete!');
    } catch (err) {
      log('Flashing failed: ' + err.message, false);
    }
  });
</script>
