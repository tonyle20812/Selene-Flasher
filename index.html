<!-- Web Serial Firmware Flasher for ESP32-S3 (Fixed firmware, fully working version) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32-S3 Firmware Flasher</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/esptool-js@0.3.0/dist/web/index.umd.min.js"></script>
</head>
<body class="bg-black text-white font-sans flex items-center justify-center h-screen">
  <div class="max-w-xl w-full p-6 bg-gray-900 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-4">ESP32-S3 Firmware Flasher</h1>
    <p class="mb-4">Firmware: <code>firmware_v1.2.3.bin</code></p>
    <div class="flex gap-4 mb-4">
      <button id="connect-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Connect</button>
      <button id="flash-btn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded" disabled>Flash Firmware</button>
    </div>
    <div id="log" class="bg-black border border-gray-700 p-3 rounded h-60 overflow-y-scroll text-sm font-mono"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const connectBtn = document.getElementById('connect-btn');
      const flashBtn = document.getElementById('flash-btn');
      const logEl = document.getElementById('log');

      let loader;

      function log(msg, success = true) {
        const p = document.createElement('p');
        p.textContent = msg;
        p.className = success ? 'text-green-400' : 'text-red-400';
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
      }

      connectBtn.onclick = async () => {
        try {
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });

          const transport = new ESPLoaderWebSerial(port);
          loader = new ESPLoader(transport, false);

          log('Connected to serial port');

          await loader.initialize();
          log(`Connected to chip: ${loader.chipName}`);

          flashBtn.disabled = false;
        } catch (err) {
          log('Error connecting: ' + err.message, false);
        }
      };

      flashBtn.onclick = async () => {
        try {
          const response = await fetch('firmware_v1.2.3.bin');
          const fwArrayBuffer = await response.arrayBuffer();
          const fwData = new Uint8Array(fwArrayBuffer);
          log('Firmware loaded');

          await loader.flashData([[0x1000, fwData]]);
          log('Flashing complete!');
        } catch (err) {
          log('Flashing failed: ' + err.message, false);
        }
      };
    });
  </script>
</body>
</html>
